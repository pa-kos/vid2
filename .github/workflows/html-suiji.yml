name: Nuclear HTML Updater

on:
  push:
    branches: [ main ]
    paths:
      - '**.html'
      - '!suiji.html'  # 严格排除自身
  workflow_dispatch:

permissions:
  contents: write

jobs:
  nuclear-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with nuclear option
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate file list
        id: files
        run: |
          # 军用级文件查找（处理所有特殊字符）
          find . -name "*.html" ! -name "suiji.html" -printf '%P\n' | sort > files.txt
          
          # 生成绝对正确的JS数组
          echo "let htmlFiles = [" > array.js
          while read -r file; do
            echo "  'https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$file'," >> array.js
          done < files.txt
          echo "];" >> array.js
          
          # 存储为输出变量
          echo "array_content=$(cat array.js)" >> $GITHUB_OUTPUT
          echo "=== 生成列表 ==="
          cat array.js

      - name: Atomic replacement
        run: |
          # 使用awk进行军用级替换
          awk -v new="$(cat array.js)" '
          /let htmlFiles = \[/ { print new; skip=1; next }
          !skip { print } 
          { skip=0 }
          ' suiji.html > temp.html && mv temp.html suiji.html
          
          echo "=== 替换验证 ==="
          grep -A20 "let htmlFiles" suiji.html

      - name: Commit with force
        run: |
          git config --global user.name "GitHub Nuclear"
          git config --global user.email "nuclear@github.com"
          git add suiji.html
          git diff --cached --quiet || {
            git commit -m "NUKE UPDATE: $(date +'%Y%m%d-%H%M%S')"
            git push origin HEAD:${{ github.ref }} --force-with-lease
          }
