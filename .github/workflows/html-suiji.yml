name: Update HTML File List

on:
  push:
    paths:
      - '**.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Find HTML files
      id: find-files
      run: |
        # 查找所有HTML文件（排除suiji.html）
        files=$(find . -name "*.html" -not -name "suiji.html" -printf '"https://%h.github.io/%p",\n' | sed 's|/./|/|g')
        
        # 生成JSON数组格式
        files_list="[${files%?}]"  # 移除最后的逗号
        echo "files_list=${files_list}" >> $GITHUB_OUTPUT
        echo "生成的文件列表："
        echo "${files_list}"

    - name: Update suiji.html
      run: |
        # 使用精确匹配替换
        replacement="let htmlFiles = ${files_list}; // Auto-updated"
        sed -i "s|let htmlFiles = \['https://[^']*REPLACE_ME\.html'\]; // !WORKFLOW-REPLACE-MARKER!|${replacement}|g" suiji.html
        
        echo "=== 替换结果验证 ==="
        grep -A5 "let htmlFiles" suiji.html

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add suiji.html
        if ! git diff --cached --quiet; then
          git commit -m "Auto-update HTML file list [skip ci]"
          git push
        else
          echo "没有检测到文件变更"
        fi
