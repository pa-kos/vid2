name: Update HTML List Automatically

on:
  push:
    branches: [ main ]
    paths:
      - '**.html'
      - '!suiji.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-html-list:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate HTML file list
      id: file-list
      run: |
        # 1. 查找所有HTML文件（排除suiji.html）
        find . -name "*.html" ! -name "suiji.html" -printf '%P\n' | sort > files.txt
        
        # 2. 生成标准JSON数组（避免格式错误）
        echo "[" > files.json
        while IFS= read -r file; do
          echo "\"https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$file\"," >> files.json
        done < files.txt
        # 移除最后一个逗号
        sed -i '$ s/,$//' files.json
        echo "]" >> files.json
        
        # 3. 输出验证
        echo "=== 生成的文件列表 ==="
        cat files.json
        
        # 4. 存储为单行JSON
        echo "html_array=$(jq -c '.' files.json)" >> $GITHUB_OUTPUT

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Update suiji.html
      run: |
        # 使用精确替换
        replacement="let htmlFiles = $(cat files.json);"
        perl -i -pe '
          BEGIN { $repl = $ENV{replacement}; }
          if (/let htmlFiles = \[/) {
            $_ = $repl;
          }
        ' suiji.html
        
        echo "=== 替换结果 ==="
        grep -A5 "let htmlFiles" suiji.html

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add suiji.html
        if ! git diff --cached --quiet; then
          git commit -m "Auto-update HTML list [skip ci]"
          git push
        fi
