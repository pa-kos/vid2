name: Auto Update Gallery List

on:
  push:
    branches: [ main ]
    paths:
      - '**.html'
      - '!suiji.html'

jobs:
  update-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # å¼ºåˆ¶è·å–æœ€æ–°ç‰ˆæœ¬
          ref: ${{ github.ref }}

      - name: Generate HTML array
        id: generate-array
        run: |
          # è·å–æ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆæ’é™¤suiji.htmlï¼‰
          HTML_FILES=$(find . -name "*.html" ! -name "suiji.html" -printf '%P\n' | sort)
          
          # ç”Ÿæˆæ ‡å‡†çš„JavaScriptæ•°ç»„æ ¼å¼
          echo "let htmlFiles = [" > array.txt
          while IFS= read -r file; do
            echo "  'https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$file'," >> array.txt
          done <<< "$HTML_FILES"
          echo "];" >> array.txt
          
          # å­˜å‚¨ä¸ºå¤šè¡Œç¯å¢ƒå˜é‡ï¼ˆä¿ç•™æ ¼å¼ï¼‰
          ARRAY_CONTENT=$(cat array.txt)
          echo "ARRAY_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$ARRAY_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # è°ƒè¯•è¾“å‡º
          echo "ç”Ÿæˆçš„æ•°ç»„å†…å®¹ï¼š"
          cat array.txt

      - name: Update suiji.html
        run: |
          # ä½¿ç”¨perlè¿›è¡Œç²¾ç¡®æ›¿æ¢ï¼ˆä¿ç•™æ ¼å¼ï¼‰
          perl -i -pe '
            BEGIN { $/ = undef; $replace = $ENV{ARRAY_CONTENT}; }
            s/(let htmlFiles = )\[.*?\];/$1$replace/s;
          ' suiji.html
          
          # éªŒè¯æ›¿æ¢ç»“æœ
          echo "=== æ›¿æ¢ç»“æœéªŒè¯ ==="
          grep -A10 "let htmlFiles" suiji.html
          
          # ç¡®ä¿æ›¿æ¢æˆåŠŸ
          if ! grep -q "$(head -n1 array.txt)" suiji.html; then
            echo "âŒ æ›¿æ¢å¤±è´¥ï¼"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --quiet suiji.html; then
            git add suiji.html
            git commit -m "Auto-update gallery list [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… æ›´æ–°å·²æäº¤"
          else
            echo "ğŸŸ¢ æ— å˜æ›´éœ€è¦æäº¤"
          fi
