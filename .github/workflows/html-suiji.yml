name: Auto Update HTML List
on:
  push:
    branches: [ main ]
    paths:
      - '**.html'          # 监控所有HTML文件变动
      - '!suiji.html'      # 排除自身文件

jobs:
  update-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # 允许提交修改
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 获取完整提交历史

      - name: Find HTML files
        id: scan-files
        run: |
          # 获取所有HTML文件（排除suiji.html）
          HTML_FILES=$(find . -name "*.html" ! -name "suiji.html" | sed 's|^./||')
          
          # 转换为GitHub Pages URL
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          HTML_URLS=$(echo "$HTML_FILES" | awk -v url="$BASE_URL" '{print url $0}')
          
          # 格式化为JS数组（保留原有缩进风格）
          JS_ARRAY="[\n$(echo "$HTML_URLS" | sed "s/^/    '/;s/$/',/")\n]"
          echo "html_files<<EOF" >> $GITHUB_ENV
          echo "$JS_ARRAY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update suiji.html
        run: |
          # 使用awk保持原格式替换（行号可能需要调整）
          awk -v new_array="$html_files" '
            /let htmlFiles = \[/ {print new_array; skip=1; next}
            skip && /\]/ {skip=0; next}
            !skip {print}
          ' suiji.html > temp.html && mv temp.html suiji.html

          # 提交更改
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add suiji.html
          git commit -m "Auto-update HTML list [skip ci]"
          git push
