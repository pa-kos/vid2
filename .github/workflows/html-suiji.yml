name: Force Update Files List

on:
  push:
    paths:
      - '**.html'
  workflow_dispatch:

# å…³é”®æƒé™å£°æ˜ï¼ˆè¦†ç›–ä»“åº“é»˜è®¤è®¾ç½®ï¼‰
permissions:
  contents: write
  pull-requests: write

jobs:
  nuclear-update:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout with full power
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Find files like a boss
      id: hunter
      run: |
        # ç”Ÿæˆç»å¯¹æ­£ç¡®çš„æ–‡ä»¶åˆ—è¡¨
        mapfile -t files < <(find . -maxdepth 1 -name "*.html" -not -name "suiji.html" -printf '%P\n')
        printf -v files_list '"https://pa-kos.github.io/vid2/%s",' "${files[@]}"
        files_list="[${files_list%,}]"
        echo "files_list=${files_list}" >> $GITHUB_OUTPUT
        echo "ğŸ” æ‰¾åˆ°æ–‡ä»¶: ${files_list}"

    - name: Atomic replacement
      run: |
        # ä½¿ç”¨Rubyè¿›è¡Œå†›ç”¨çº§æ›¿æ¢ï¼ˆæ— è§†æ‰€æœ‰æ ¼å¼é—®é¢˜ï¼‰
        replacement="let htmlFiles = ${files_list}; // !AUTO-UPDATED!"
        ruby -i -pe '
          if /!AUTO-UPDATED-MARKER-V2!/
            $marker = true
          elsif $marker && /!REPLACE-THIS-LINE-V2!/
            $_ = "let htmlFiles = #{ENV['replacement']};\n"
            $marker = false
          end
        ' suiji.html

        echo "=== æ›¿æ¢éªŒè¯ ==="
        grep -A3 "htmlFiles" suiji.html
        if ! grep -q "${files_list}" suiji.html; then
          echo "âŒ ç»ˆææ›¿æ¢å¤±è´¥ï¼"
          exit 1
        fi

    - name: Terminator push
      run: |
        git config --global user.name "GitHub Actions Terminator"
        git config --global user.email "terminator@github.com"
        git add suiji.html
        git commit -m "TERMINATOR UPDATE: $(date +'%Y%m%d-%H%M%S')" || echo "æ— å˜æ›´å¯æäº¤"
        git push origin HEAD:${GITHUB_REF#refs/heads/} --force-with-lease
