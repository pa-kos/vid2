name: Update HTML Files List

on:
  push:
    paths:
      - '**.html'
  workflow_dispatch:

permissions: write-all  # 关键权限设置

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Find HTML files
      id: find-files
      run: |
        # 生成标准文件列表（完全绕过解析问题）
        files=$(find . -maxdepth 1 -name "*.html" -not -name "suiji.html" -printf '"https://pa-kos.github.io/vid2/%P",\n')
        echo "[" > files.json
        echo "${files%?}" >> files.json  # 移除末尾逗号
        echo "]" >> files.json
        files_json=$(tr -d '\n\r' < files.json)
        echo "files_list=${files_json}" >> $GITHUB_OUTPUT
        echo "生成列表：${files_json}"

    - name: Nuclear replacement
      run: |
        # 使用Perl进行原子级替换（无视所有格式问题）
        replacement="let htmlFiles = ${files_list}; // !AUTO-UPDATED!"
        perl -i -pe '
          BEGIN { $replacement = qq{'"${replacement}"'}; }
          if (/!AUTO-UPDATED-MARKER-V2!/../!REPLACE-THIS-LINE-V2!/) {
            s/let htmlFiles = .*?;/'"${replacement}"';/ if /!REPLACE-THIS-LINE-V2!/;
          }
        ' suiji.html

        echo "=== 替换验证 ==="
        grep -A3 "htmlFiles" suiji.html
        if ! grep -q "${files_list}" suiji.html; then
          echo "❌ 替换失败！"
          exit 1
        fi

    - name: Force push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add suiji.html
        git commit -m "FORCE UPDATE: File list" || echo "无变更"
        git push origin HEAD:${GITHUB_REF#refs/heads/} --force
