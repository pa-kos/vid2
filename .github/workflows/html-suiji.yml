name: Update HTML Files List

on:
  push:
    paths:
      - '**.html'
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup environment
      run: |
        sudo apt-get install -y jq
        mkdir -p tmp
        
    - name: Find valid HTML files
      id: file-finder
      run: |
        # 只查找根目录下的HTML文件，排除子目录和suiji.html
        find . -maxdepth 1 -name "*.html" -not -name "suiji.html" -printf '%P\n' > tmp/files.txt
        
        # 验证并格式化URL
        echo "VALID_FILES=[" > tmp/valid_files.txt
        while IFS= read -r file; do
          if [[ "$file" == */* ]]; then
            echo "跳过包含子目录的文件: $file" >&2
          else
            echo "\"https://pa-kos.github.io/vid2/$file\"," >> tmp/valid_files.txt
          fi
        done < tmp/files.txt
        
        # 移除最后一个逗号并闭合数组
        sed -i '$ s/,$//' tmp/valid_files.txt
        echo "]" >> tmp/valid_files.txt
        
        # 转换为单行JSON
        files_json=$(jq -c '.' tmp/valid_files.txt)
        echo "files_list=${files_json}" >> $GITHUB_OUTPUT
        echo "最终有效文件列表:"
        cat tmp/valid_files.txt
        
    - name: Update suiji.html
      run: |
        # 使用精确模式替换
        replacement="let htmlFiles = ${files_list}; // Auto-updated by GitHub Actions"
        sed -i "s|let htmlFiles = \\[.*\\]; // Auto-updated by GitHub Actions|${replacement}|g" suiji.html
        sed -i "s|let htmlFiles = \\['https://YOUR_GITHUB_USERNAME.github.io/vid2/placeholder.html'\\];|${replacement}|g" suiji.html
        
        echo "更新后的内容:"
        grep -A5 "let htmlFiles" suiji.html
        
    - name: Commit changes
      if: always()
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add suiji.html
        if ! git diff --staged --quiet; then
          git commit -m "Auto-update HTML files list [skip ci]"
          git push
        else
          echo "没有检测到文件变更"
        fi
