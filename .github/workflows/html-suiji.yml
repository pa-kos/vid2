name: Update HTML Files List

on:
  push:
    paths:
      - '**.html'
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup environment
      run: sudo apt-get install -y jq
    
    - name: Find and validate HTML files
      id: file-finder
      run: |
        # 1. 查找有效的HTML文件
        find . -maxdepth 1 -name "*.html" -not -name "suiji.html" -printf '%P\n' | while read -r file; do
          if [[ "$file" =~ ^[a-zA-Z0-9_.-]+\.html$ ]]; then
            echo "\"https://pa-kos.github.io/vid2/$file\""
          else
            echo "跳过无效文件名: $file" >&2
          fi
        done > valid_files.txt
        
        # 2. 手动构建JSON数组（避免jq解析问题）
        echo "[" > files_array.json
        paste -sd, valid_files.txt >> files_array.json
        echo "]" >> files_array.json
        
        # 3. 验证并输出
        files_json=$(tr -d '\n' < files_array.json)
        echo "生成的文件列表: $files_json"
        echo "files_list=$files_json" >> $GITHUB_OUTPUT
        
    - name: Update suiji.html
  run: |
    # 严格模式替换（兼容不同换行符）
    replacement="let htmlFiles = ${files_list}; // !AUTO-UPDATED!"
    sed -i -E ':a;N;$!ba;s|// !AUTO-UPDATED-FILES!.*[\r\n]+let htmlFiles = \['https://[^']+REPLACE_ME\.html'\];.*[\r\n]+|// !AUTO-UPDATED-FILES! (DO NOT EDIT THIS LINE)\n${replacement}\n|g' suiji.html
    
    # 验证替换
    echo "=== 替换结果验证 ==="
    grep -A2 "let htmlFiles" suiji.html
    if ! grep -q "${files_list}" suiji.html; then
      echo "❌ 替换失败！"
      exit 1
    fi
        
    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add suiji.html
        if ! git diff --cached --quiet; then
          git commit -m "Auto-update files list [skip ci]"
          git push
        fi
